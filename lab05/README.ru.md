# Лабораторная работа 05: Компиляция в Wasm

[RU|[EN](README.md)]

Это упражнение построено на грамматике из [лабораторной работы 03](../lab03/README.ru.md), синтакически разбираемой парсером из [лабораторной работы 04](../lab04/README.ru.md) для построения мини-компилятора арифметических выражений в формат инструкций WebAssembly.

## Цель

В этой лабораторной работе мы будем практиковаться в компиляции кода в байткод Wasm. Подробное описание виртуальной машины WebAssembly можно найти на [странице проекта Wasm][wasm].
Обратите внимание на то, что мы уходим от способа передачи аргументов функции, использованного в [лабораторной работе 03](../lab03/README.ru.md).
Передача аргументов сложных типов (вроде словарей) в Wasm требует значительных усилий. Гораздо легче передать несколько числовых аргументов. Поэтому, вместо передачи словаря именованных аргументов мы попробуем *вывести сигнатуру функции* из описания ее тела.
Идея состоит в перечислении всех переменных, использованных в выражении (в порядке их упоминания), и превращении их в параметры функции:

- `42` компилируется в функцию без аргументов `f()`
- `42+h` компилируется в функцию одного аргумента `f(h)`
- `a+h` компилируется в функцию двух аргументов `f(a, h)`
- `a+h*a` компилируется в функцию двух аргументов `f(a, h)`

Процесс построения списка параметров лучше вынести в отдельную функцию, чтобы потом иметь возможность заменить ее другой реализацией.
Однажды нам может захотеться добавить какие-нибудь формальные параметры в функцию несмотря на то, что они вообще не используются в ее теле; поэтому мы сделаем их список отдельным параметром функции [`buildFunction`](src/compiler.ts).

Виртуальная машина Wasm - это 'стековая машина с переменными', такая же, как [JVM] или [CLR].
То есть все операции выполняются над стеком. В некотором смысле, нам нужно преобразовать наше инфиксное выражение в обратную польскую запись, изученную в [лабораторной работе 02](../lab02/README.md). Пакет [`wasm`](../wasm/), включенный в этот курс упражнений, прячет эту подробность, чтобы предоставить улучшенный контроль за корректностью порождаемого Wasm-кода, но "под капотом" вся арифметика выполняется над значениями в стеке.
Константы загружаются в стек "как есть", их непосредственное значение включается в инструкцию байт-кода. Аргументы функции загружаются по индексу, так что переменная номер 0 ссылается на первый аргумент функции, переменная номе 1 - на второй, и так далее.

Значение, оставшееся на стеке при окончании исполнения функции становится ее возвращаемым значением.

## Задачи

1. Реализуйте в файле [compiler.ts](src/compiler.ts) функцию `getVariables`, которая строит массив имен переменных, использованных в выражении
2. Реализуйте в файле [compiler.ts](src/compiler.ts) функцию `wasm`, которая превращает AST выражения в байткод Wasm

## Оценка

- C | 3 | Воу, воу, полегче:
  - Реализуйте компиляцию всех видов арифметических выражений
  - Убедитесь, что синтаксические ошибки приводят к выбросу верного исключения
  - Убедитесь, что деление на ноль выбрасывает исключение
- B | 4 | Ломай меня полностью:
  - Убедитесь, что обращение к переменной, не входящей в список, выбрасывает исключение `WebAssembly.RuntimeError`

## Советы

1. WebAssembly поддерживает несколько числовых типов, в то время, как JS (и, соответственно, TS) обходятся типами `number` и `bigint`. В этой лабораторной работе мы предположим, что наш калькулятор работает со значениями типа `i32`, и проигнорируем то, что тип `number` шире него. Реализация WebAssembly в `node.js` автоматически проведет для нас конвертацию данных. Можно было бы использовать тип `i64`, но это бы потребовало дополнительных усилий по конвертации возвращаемых значений, так как они перестали бы заведомо помещаться в тип `number`.
2. Обратите внимпание на то, что деление на ноль в WebAssembly бросает исключение, устраняя необходимость в специальной обработке, которую приходилось делать в лабораторной работе 03.
3. Пакет [`wasm`](../wasm/), на который ссылается эта лабораторная работа, является неточной копией GitHub-проекта  [wasm-util]. See the project's homepage for the samples and usage hints.

[wasm]: https://webassembly.org/
[JVM]: https://docs.oracle.com/javase/specs/jvms/se8/html/
[CLR]: https://www.ecma-international.org/wp-content/uploads/ECMA-335_6th_edition_june_2012.pdf
[wasm-util]: https://github.com/rsms/wasm-util
